## Scalarizr Windows installer

As of the time of writing, Scalarizr uses wix toolkit for packing omnibus-msi packages.
There is some ambiguity in official wix and windows installer documentation, especially in sections related to
installer actions sequence. Therefore this document was created in order to describe the way omnibus, wix and windows
installer operate in conjunction in this particular setup.

All package behavior customisations are described in:

 - omnibus software profile configuration in `onibus/config/software/*.rb` and `omnibus/config/projects/*.rb` files
 - a `omnibus/resources/scalarizr/msi/source.wxs.erb` teplate(mostly xml, a bit of ruby .erb template)
 - `omnibus/package-scripts/scalarizr/msi_install_actions.py` python script

During a build a package contents filetree is generated by parsing a set of software profiles, it is then passed as a
single object into a source.wxs.erb template which, in turn, is converted into source.wxs file representing a complete
package behaviour xml-configuration.

 A .wxs file can be formally split into following sections:

 - A package general info like vesion, upgradecode, manufacturer info etc. (mostly described at the top of the file)
 - A set of property and action declarations
 - An `<InstallExecuteSequence/>` tag, describing actual action call schedule
 - A package contents description(directory structure)
 - Description of package features(enables setup customisation in terms of contets from end user side)


### Installscripts and wix config file.
All pre- and post- (un)install actions are declared in an action/property section via pattern:

```xml
<CustomAction Id="ActionIdentifier1" Property="PropName" Value="abspath\to\executable.exe" />

<CustomAction Id="ActionIdentifier2"
        Property="PropName"
        ExeCommand=" -set -of --executable --arguments "
        Return="ignore"
        />
```

And later are scheduled for a call iside `InstallExecuteSequence` tag.
An action can be scheduled to run in a specific moment of install sequence via `After="ActionId"` attribute

```xml
<InstallExecuteSequence>
    <Custom Action="ActionIdentifier1" After="InstallInitialize"/>
    <Custom Action="ActionIdentifier2" After="ActionIdentifier1"/>
</InstallExecuteSequence>

```

A custom action can be scheduled to install only in specific installation conditions via corresponding installer
properties.

```xml
<InstallExecuteSequence>

    <Custom Action="ActionIdentifier1" After="InstallInitialize">
        (NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")
    </Custom>
    <Custom Action="ActionIdentifier2" After="ActionIdentifier1">
        (NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")
    </Custom>

</InstallExecuteSequence>

```
    Note that upgrade process, in windows installer terms, is conducted in two transactions.
The first uninstalls an old package and the second installs a new package.
Each transaction triggers execution of a full set of actions defined in InstallExecuteSequence. Therefore for all
custom actions it should be specified whether an action should run in a given installation type(install, upgrade,
uninstall etc.)

We use combinations of the following 3 windows installer bool properties in order to specify execution conditions:

 - `UPGRADINGPRODUCTCODE` - this property is `TRUE` when the first upgrade transaction(uninstall old) takes place.
In current implementation we never want any custom actions to run in this situation, so for all custom actions we use
`NOT UPGRADINGPRODUCTCODE`

 - `Installed` - a product is already installed on the system

 - `REMOVE="ALL"` - all features are scheduled for removal

                    | Install | Upgrade 1st tr.| Upgrade 2nd tr.| Uninstall
--------------------|---------|----------------|----------------|----------
UPGRADINGPRODUCTCODE| False   | True           | False          | False
Installed           | False   | True           | False          | True
REMOVE="ALL"        | False   | True           | False          | True


Besides custom actions, we can configure specific [builtin installer actions](https://msdn.microsoft.com/en-us/library/aa372038(v=vs.85).aspx) to run/skip in certain conditions.
```xml
<InstallExecuteSequence>
     <!-- This action will never occur -->
    <StopServices Suppress="yes" />
    <!-- This action wll only run on uninstall -->
    <RemoveFiles Suppress="yes">
        (NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")
    </RemoveFiles>
</InstallExecuteSequence>
```

--

#### Related links
- [Useful windows installer tips](http://www.robertdickau.com/msi_tips.html)
- [Official wix documentation](http://wixtoolset.org/documentation/)
- [MSDN windows installer documentation](https://msdn.microsoft.com/en-us/library/aa371366(v=vs.85).aspx)
